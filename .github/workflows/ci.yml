name: Gazebo RViz CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        gazebo: ['fortress', 'garden']
        ros: ['humble', 'rolling']
    container:
      image: osrf/ros:${{ matrix.ros }}-desktop
    env:
      GZ_VERSION: ${{ matrix.gazebo }}
    steps:
    - uses: actions/checkout@v3
    - name: Install Dependencies
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt update -qq
        apt install -qq -y lsb-release wget curl gnupg2 git
        curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null
        wget https://packages.osrfoundation.org/gazebo.gpg -O /usr/share/keyrings/pkgs-osrf-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/pkgs-osrf-archive-keyring.gpg] http://packages.osrfoundation.org/gazebo/ubuntu-stable $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/gazebo-stable.list > /dev/null
        apt update -y
        echo "Gazebo version " $GZ_VERSION
        if [ "$GZ_VERSION" == "garden" ]; then
          apt install -y libgz-common5-dev \
                         libgz-math7-dev \
                         libgz-rendering7-dev \
                         libgz-gui7-dev
        fi

        if [ "$GZ_VERSION" == "fortress" ]; then
          apt install -y libignition-common4-dev \
                         libignition-math6-dev \
                         libignition-rendering6-dev \
                         libignition-gui6-dev
        fi
    - name: Setup colcon workspace
      id: configure
      run: |
        cd ..
        mkdir -p /home/colcon_ws/src
        cp -r gz-rviz /home/colcon_ws/src/
    - name: Build project
      id: build
      run: |
        cd /home/colcon_ws/
        . /opt/ros/${{ matrix.ros }}/setup.sh
        colcon build
    - name: Run tests
      id: test
      run: |
        cd /home/colcon_ws/
        . /opt/ros/${{ matrix.ros }}/setup.sh
        colcon test --event-handlers console_direct+
        colcon test-result
